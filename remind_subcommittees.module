<?php

function remind_subcommittees_menu() {
    $items = array();
   
    //Link to the test_module admin page:
    $items['remind_subcommittees'] = array(
        'title' => 'Remind Subcommittees',
        'page callback' => 'remind_subcommittees_check',
        'type' => MENU_CALLBACK,
        'access callback' => TRUE
    );
   
    return $items;
}

function remind_subcommittees_check() {
    $time_values = array(
        'Weekly' => 60*60*24*7,
        'Fortnightly' => 60*60*24*14,
        'Monthly' => 60*60*24*30,
        'Bimonthly' => 60*60*24*60,
        'Quarterly' => 60*60*24*91,
        'Half Yearly' => 60*60*24*182,
        'Annually' => 60*60*24*365,
    );

    $query = db_query("SELECT * FROM {node} WHERE type = 'subcommittee'");
    while ( $row = db_fetch_object($query) ) {
        $subcommittee = node_load($row->nid);
        $query2 = db_query("SELECT * FROM {content_type_report}, {node} WHERE content_type_report.field_report_references_nid = %d AND content_type_report.nid = node.nid ORDER BY node.created DESC LIMIT 1", $row->nid);
        $last_report = db_fetch_object($query2);
        $report_period = $time_values[$subcommittee->field_reporting_period[0]['value']];
        $last_reminder = strtotime($subcommittee->field_subcommittee_last_reminder[0]['value']);
        $due_time = strtotime($subcommittee->field_next_report_date[0]['value']);
        print ( $subcommittee->title . ' ' . date('Y-m-d', $last_report) . ' ' date('Y-m-d', $due_time) );

        if ( $subcommittee->field_subcommittee_status[0]['value'] == 'Active subcommittee' ) {
            if ( strtotime($subcommittee->field_next_report_date[0]['value']) < time() ) {
                if ( $last_report->created >= $due_time ) {
                    // report already submitted... Automatically update the due date of the next one
                    $subcommittee->field_next_report_date[0]['value'] = date('Y-m-d', $due_time + $report_period) . 'T00:00:00';
                    print_r($subcommittee);
                }
                else {
                    if ( ($due_time - time()) <= (60*60*24*7) ) {
                        // within 7 days of due
                        if ( ($due_time - $last_reminder) <= (60*60*24*7) ) {
                            // haven't already been reminded, so send one
                            remind_subcommittees_send_email($subcommittee);
                        }
                    }
                    
                    $overdue_email = false;
                    if ( time > $due_time ) {
                        if ( $last_reminder < $due_time ) {
                            remind_subcommittees_overdue($subcommittee); // The report has just become due
                        }
                        else if ( (time() - $last_reminder) > (60*60*24*3) ) {
                            remind_subcommittees_overdue($subcommittee); // send a reminder every 3 days
                        }
                    }
                }
            }
        }
    }
}

function remind_subcommittees_overdue($subcommittee) {
    $message = "remind overdue!!!";
    remind_subcommittees_send_email($subcommittee, $message);
}

function remind_subcommittees_send_email($subcommittee, $message = null) {
    if ( $message == null ) {
        // set default reminder email
        $message = "remind";
    }
    print $message;
}

?>
